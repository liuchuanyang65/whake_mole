{
  "code": "import { gameData } from \"./gameData\";\r\nexport class WXCloud {\r\n    constructor() {\r\n        this.needWait = true;\r\n        this.needUpdatet = false;\r\n        WXCloud._instance = this;\r\n        if (Laya.Browser.onMiniGame) {\r\n            Laya.Browser.window.wx.cloud.init({\r\n                env: 'lcy-xhwgt'\r\n            });\r\n            WXCloud.db = Laya.Browser.window.wx.cloud.database({\r\n                env: 'lcy-xhwgt'\r\n            });\r\n        }\r\n    }\r\n    Init(mgr) {\r\n        this.mgr = mgr;\r\n    }\r\n    CreateCloudData() {\r\n        WXCloud.db.collection('user').where({\r\n            _openid: gameData.player.id,\r\n        })\r\n            .get().then(res => {\r\n            if (res.data.length == 0) {\r\n                WXCloud.db.collection('user').add({\r\n                    data: {\r\n                        _id: gameData.player.id,\r\n                        avatarUrl: gameData.player.avatarUrl,\r\n                        nickName: gameData.player.nickName,\r\n                    }\r\n                })\r\n                    .then(res => {\r\n                });\r\n            }\r\n            else {\r\n                gameData.player.maxScore = res.data[0].score;\r\n            }\r\n        });\r\n    }\r\n    SelfCloudSave(id, content) {\r\n        WXCloud.db.collection('user').doc(id).update({\r\n            data: content,\r\n            success: function (res) {\r\n                this.SuccessEvent(res);\r\n            }.bind(this),\r\n            fail: function (res) {\r\n                console.log(\"fail\" + res);\r\n            }.bind(this),\r\n        });\r\n    }\r\n    UpdateChallengeData(id, needToHome = true) {\r\n        if (id == gameData.player.id) {\r\n            this.mgr.ShowGameTip();\r\n            return;\r\n        }\r\n        WXCloud.db.collection('user').where({\r\n            _openid: id,\r\n        })\r\n            .get().then(res => {\r\n            if (res.data.length == 0) {\r\n            }\r\n            else {\r\n                if (id == gameData.player.id) {\r\n                    this.mgr.ShowGameTip();\r\n                    return;\r\n                }\r\n                gameData.player.ifcanChallenge = true;\r\n                gameData.player.c_id = id;\r\n                gameData.player.c_nickName = res.data[0].nickName;\r\n                gameData.player.c_avatarUrl = res.data[0].avatarUrl;\r\n                gameData.player.c_maxScore = res.data[0].score;\r\n                if (!this.needWait) {\r\n                    if (needToHome) {\r\n                        this.mgr.UpdateHomeChallenge();\r\n                    }\r\n                }\r\n                else {\r\n                    if (needToHome) {\r\n                        this.needUpdatet = true;\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n    SuccessEvent(res) {\r\n    }\r\n    FailEvent(res) {\r\n    }\r\n    CallFunction(funcName) {\r\n        Laya.Browser.window.wx.cloud.callFunction({\r\n            name: funcName,\r\n            data: {\r\n                desc: \"get UID\"\r\n            },\r\n            success: function (res) {\r\n                this.Func_SuccessEvent(res.result);\r\n            }.bind(this),\r\n            fail: function (res) {\r\n                this.Func_FailEvent(res.result);\r\n            }.bind(this),\r\n        });\r\n    }\r\n    Func_SuccessEvent(res) {\r\n        if (res.type == \"getUID\") {\r\n            gameData.player.id = res.openid;\r\n            this.needWait = false;\r\n            this.CreateCloudData();\r\n            if (this.needUpdatet) {\r\n                this.needUpdatet = false;\r\n                if (gameData.player.c_id == gameData.player.id) {\r\n                    this.mgr.ShowGameTip();\r\n                    gameData.player.ifcanChallenge = false;\r\n                    gameData.player.c_id = \"\";\r\n                    gameData.player.c_nickName = \"\";\r\n                    gameData.player.c_avatarUrl = \"\";\r\n                    gameData.player.c_maxScore = 0;\r\n                }\r\n                else {\r\n                    this.mgr.UpdateHomeChallenge();\r\n                }\r\n            }\r\n        }\r\n        else {\r\n        }\r\n    }\r\n    Func_FailEvent(res) {\r\n    }\r\n}\r\n",
  "references": [
    "C:/Users/dell/Desktop/my_mouse/src/script/gameData.ts",
    "C:/Users/dell/Desktop/my_mouse/src/script/game_mgr.ts"
  ]
}
