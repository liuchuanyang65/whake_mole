!function(){"use strict";class e{constructor(){this.PlayModel=0,e._instance=this,e.player=new t}}class t{constructor(){this.avatarUrl="",this.nickName="",this.id="",this.maxScore=0,this.ifcanChallenge=!1,this.c_avatarUrl="",this.c_nickName="",this.c_id="",this.c_maxScore=0}}class i extends Laya.Script{constructor(){super(),this.mouse_type=1,this.time_line=null,this.is_dead=!1,this.mgr=null,this.hole_index=0,this.mouse_type=1}showMouse(t,i=1,a,s){this.mgr=t,this.mouse_type=i,this.hole_index=a;var n=this.owner;n.skin="res/mouse_normal_"+this.mouse_type+".png",Laya.Browser.onMiniGame&&1==e._instance.PlayModel?(this.icon_Img.visible=!0,1==this.mouse_type?this.icon_Img.skin=e.player.c_avatarUrl:this.icon_Img.skin=e.player.avatarUrl):this.icon_Img.visible=!1,n.scaleX=0,n.scaleY=0;var l=Laya.TimeLine.to(n,{scaleX:1,scaleY:1},300);l.to(n,{scaleX:0,scaleY:0},300,null,100*s*this.mouse_type),l.play(0,!1),l.on(Laya.Event.COMPLETE,this,function(){n.removeSelf()}),this.time_line=l}onStart(){}hitedMouse(){null!=this.time_line&&(this.time_line.destroy(),this.time_line=null);var e=this.owner;e.skin="res/mouse_hit_"+this.mouse_type+".png";var t=Laya.TimeLine.to(e,{scaleX:0,scaleY:0},300,null,300);t.play(0,!1),t.on(Laya.Event.COMPLETE,this,function(){e.removeSelf()})}onClick(){this.is_dead||(this.is_dead=!0,this.hitedMouse(),this.mgr.mouseBeHited(this.mgr,this.mouse_type,this.hole_index))}}class a extends Laya.Script{constructor(){super()}onEnable(){}onDisable(){}onUpdate(){}showHammer(){var e=this.owner;e.rotation=0,e.alpha=1;var t=Laya.TimeLine.to(e,{rotation:9},100);t.to(e,{rotation:-9},150),t.to(e,{rotation:0},100),t.to(e,{alpha:0},200,null,200),t.play(0,!1)}onStart(){}}class s extends Laya.Script{constructor(){super()}onEnable(){}onDisable(){}onUpdate(){}showScore(e,t=1,i){var a=this.owner;a.skin="res/score_"+t+".png",a.rotation=0,a.alpha=1;var s=Laya.TimeLine.to(a,{y:a.y-15,alpha:0},300,null,200);s.play(0,!1),s.on(Laya.Event.COMPLETE,this,function(){a.removeSelf(),e.scoreCount(t)})}onStart(){}}class n{constructor(){this.needWait=!0,this.needUpdatet=!1,n._instance=this,Laya.Browser.onMiniGame&&(Laya.Browser.window.wx.cloud.init({env:"lcy-xhwgt"}),n.db=Laya.Browser.window.wx.cloud.database({env:"lcy-xhwgt"}))}Init(e){this.mgr=e}CreateCloudData(){n.db.collection("user").where({_openid:e.player.id}).get().then(t=>{0==t.data.length?n.db.collection("user").add({data:{_id:e.player.id,avatarUrl:e.player.avatarUrl,nickName:e.player.nickName}}).then(e=>{}):e.player.maxScore=t.data[0].score})}SelfCloudSave(e,t){n.db.collection("user").doc(e).update({data:t,success:function(e){this.SuccessEvent(e)}.bind(this),fail:function(e){console.log("fail"+e)}.bind(this)})}UpdateChallengeData(t,i=!0){t!=e.player.id?n.db.collection("user").where({_openid:t}).get().then(a=>{if(0==a.data.length);else{if(t==e.player.id)return void this.mgr.ShowGameTip();e.player.ifcanChallenge=!0,e.player.c_id=t,e.player.c_nickName=a.data[0].nickName,e.player.c_avatarUrl=a.data[0].avatarUrl,e.player.c_maxScore=a.data[0].score,this.needWait?i&&(this.needUpdatet=!0):i&&this.mgr.UpdateHomeChallenge()}}):this.mgr.ShowGameTip()}SuccessEvent(e){}FailEvent(e){}CallFunction(e){Laya.Browser.window.wx.cloud.callFunction({name:e,data:{desc:"get UID"},success:function(e){this.Func_SuccessEvent(e.result)}.bind(this),fail:function(e){this.Func_FailEvent(e.result)}.bind(this)})}Func_SuccessEvent(t){"getUID"==t.type&&(e.player.id=t.openid,this.needWait=!1,this.CreateCloudData(),this.needUpdatet&&(this.needUpdatet=!1,e.player.c_id==e.player.id?(this.mgr.ShowGameTip(),e.player.ifcanChallenge=!1,e.player.c_id="",e.player.c_nickName="",e.player.c_avatarUrl="",e.player.c_maxScore=0):this.mgr.UpdateHomeChallenge()))}Func_FailEvent(e){}}class l{constructor(){this.isChallenge=!1,this.challengeId="",l._instance=this,Laya.Browser.onMiniGame&&(l.wx=Laya.Browser.window.wx,this.InitShare(),this.onShow())}InitShare(){Laya.Browser.onWeiXin&&(console.log("初始化分享设置～"),l.wx.showShareMenu({withShareTicket:!0,success:function(e){console.log("开启转发成功～")},fail:function(e){console.log("开启转发失败～")},complete:function(e){}}),l.wx.onShareAppMessage(function(){return{title:"打地鼠可好玩了,快来挑战我吧～"}}))}doShare(t){var i=`${t}向你发起挑战！`;if(console.log(i),Laya.Browser.onWeiXin){const t={title:i,query:`action=challenge&userId=${e.player.id}`};l.wx.shareAppMessage(t)}}onShow(){Laya.Browser.onWeiXin&&l.wx.onShow(e=>{e.shareTicket;let t=e.query;null!=t&&"challenge"==t.action&&(console.log(t.userId),this.challengeId=t.userId,null!=n._instance.mgr?n._instance.UpdateChallengeData(this.challengeId):this.isChallenge=!0)})}}class o extends Laya.Script{constructor(){super(),this.maxScore=0}ShowOver(t){if(this.mgr=t,this.maxScore=this.mgr.score>e.player.maxScore?this.mgr.score:e.player.maxScore,Laya.Browser.onMiniGame){this.icon_Img.skin=e.player.avatarUrl,this.name_text.text=e.player.nickName;var i={avatarUrl:e.player.avatarUrl,nickName:e.player.nickName,score:this.maxScore};n._instance.SelfCloudSave(e.player.id,i)}this.back_btn.on(Laya.Event.CLICK,this,this.OnClickBack),this.challenge_btn.on(Laya.Event.CLICK,this,this.onClickChallenge),this.UpdateOverUI()}UpdateOverUI(){this.all_score.text=this.mgr.score.toString(),this.max_score.text=this.maxScore.toString(),1==e._instance.PlayModel?(this.m_icon_Img.skin=e.player.avatarUrl,this.m_name_text.text=e.player.nickName,this.m_score_text.text=this.mgr.score.toString(),this.c_icon_Img.skin=e.player.c_avatarUrl,this.c_name_text.text=e.player.c_nickName,this.c_score_text.text=e.player.c_maxScore.toString(),this.mgr.score>e.player.c_maxScore?this.challenge_Result.text="胜":this.challenge_Result.text="败",this.challenge_Box.visible=!0,this.icon_Img.visible=!1):(this.challenge_Box.visible=!1,this.icon_Img.visible=!0)}OnClickBack(){this.mgr.showWhichBack(1)}onClickChallenge(){l._instance.doShare(e.player.nickName)}}class r extends Laya.Script{constructor(){super()}BeginGame(){0==e._instance.PlayModel?(this.self_score_box.visible=!0,this.self_icon.skin=e.player.avatarUrl,this.self_name.text=e.player.nickName,this.challenge_score_box.visible=!1):(this.self_score_box.visible=!0,this.self_icon.skin=e.player.avatarUrl,this.self_name.text=e.player.nickName,this.challenge_score_box.visible=!0,this.challenge_icon.skin=e.player.c_avatarUrl,this.challenge_name.text=e.player.c_nickName,this.challenge_score.text=e.player.c_maxScore.toString())}}class h extends Laya.Script{constructor(){super(),this.start_btn=null,this.begin_btn=null,this.desc_Img=null,this.icon_Img=null,this.name_text=null,this.c_icon_Img=null,this.c_name_text=null,this.desc_shareTip=null,this.desc_challenge_btn=null,this.desc_back_btn=null,this.rate=1}onAwake(){this.c_icon_Img.visible=!1}Init(t){this.mgr=t,this.desc_Img.visible=!1,this.begin_btn.visible=!1,this.start_btn.visible=!1,this.challenge_btn.visible=!1,this.icon_Img.visible=!1,this.start_btn.on(Laya.Event.CLICK,this,this.OnClickStart),this.challenge_btn.on(Laya.Event.CLICK,this,this.OnClickChallenge),this.begin_btn.on(Laya.Event.CLICK,this,this.OnClickBegin),this.desc_challenge_btn.on(Laya.Event.CLICK,this,this.OnClickShareChallenge),this.desc_back_btn.on(Laya.Event.CLICK,this,this.OnClickback),Laya.Browser.onMiniGame?(this.rate=wx.getSystemInfoSync().windowWidth/1080,Laya.Browser.window.wx.getUserInfo({success:function(t){e.player.avatarUrl=t.userInfo.avatarUrl,e.player.nickName=t.userInfo.nickName,this.UpdatePlayerUI(),this.DefaultState()}.bind(this),fail:function(e){console.log(e),this.ShowWXButton()}.bind(this)}),n._instance.CallFunction("getUID")):this.DefaultState()}UpdateHomeChallenge(){this.c_icon_Img.skin=e.player.c_avatarUrl,this.c_name_text.text=e.player.c_nickName,null!=this.wxbutton?this.c_icon_Img.visible=!0:(this.c_icon_Img.visible=!0,this.DefaultState())}ShowWXButton(){this.desc_Img.visible=!1,this.begin_btn.visible=!1,this.start_btn.visible=!1,this.challenge_btn.visible=!1;var t=(wx.getSystemInfoSync().windowWidth-178)/2,i=.7*wx.getSystemInfoSync().windowHeight;this.wxbutton=Laya.Browser.window.wx.createUserInfoButton({type:"image",image:"res/btn_souquan.png",style:{left:t,top:i,width:178,height:59}}),this.wxbutton.onTap(t=>{e.player.avatarUrl=t.userInfo.avatarUrl,e.player.nickName=t.userInfo.nickName,this.UpdatePlayerUI(),e.player.ifcanChallenge?this.OnClickChallenge():this.OnClickStart()})}UpdatePlayerUI(){Laya.Browser.onMiniGame&&(this.icon_Img.skin=e.player.avatarUrl,this.name_text.text=e.player.nickName)}DefaultState(){this.icon_Img.visible=!0,this.desc_Img.visible=!1,this.begin_btn.visible=!1,this.start_btn.visible=!0,this.challenge_btn.visible=!0}OnClickStart(){this.desc_self_ICON.skin="res/mouse_normal_2.png",this.desc_C_ICON.skin="res/mouse_normal_1.png",this.desc_Img.visible=!0,this.begin_btn.visible=!0,this.start_btn.visible=!1,this.desc_shareTip.visible=!1,this.challenge_btn.visible=!1,e._instance.PlayModel=0,this.wxbutton&&this.wxbutton.destroy()}OnClickChallenge(){e.player.ifcanChallenge?(this.begin_btn.visible=!0,this.desc_shareTip.visible=!1,this.desc_self_ICON.skin=e.player.avatarUrl,this.desc_C_ICON.skin=e.player.c_avatarUrl,e._instance.PlayModel=1):(this.begin_btn.visible=!1,this.desc_shareTip.visible=!0,this.desc_self_ICON.skin="res/mouse_normal_2.png",this.desc_C_ICON.skin="res/mouse_normal_1.png"),this.desc_Img.visible=!0,this.start_btn.visible=!1,this.challenge_btn.visible=!1,this.wxbutton&&this.wxbutton.destroy()}OnClickBegin(){1==e._instance.PlayModel&&Laya.Browser.onMiniGame&&n._instance.UpdateChallengeData(e.player.c_id,!1),this.mgr.showWhichBack(2),this.DefaultState()}OnClickback(){this.DefaultState()}OnClickShareChallenge(){l._instance.doShare(e.player.nickName)}}class c extends Laya.Script{constructor(){super(),this.mouse_prefab=null,this.mouse_root=null,this.hammer=null,this.score_prefab=null,this.score_root=null,this.all_score=null,this.count_down=null,this.point_list=null,this.canvas=null,this.homeBack=null,this.overCanvas=null,this.init=!1,this.score=0,this.time=0,this.roundTime=30,new e,n._instance.Init(this)}onAwake(){if(!this.init&&(this.over_Ctrl=this.overCanvas.getComponent(o),this.home_Ctrl=this.homeBack.getComponent(h),this.main_Ctrl=this.canvas.getComponent(r),this.home_Ctrl.Init(this),this.point_list)){var t=this.point_list.numChildren;e.pointArray=[];for(var i=0;i<t;i++){var a=this.point_list.getChildAt(i),s={x:a.x,y:a.y+80};e.pointArray.push(s)}}}ShowGameTip(){this.game_Tip.visible=!0}UpdateHomeChallenge(){this.home_Ctrl.UpdateHomeChallenge(),this.showWhichBack(1)}createMouses(){var t=this.mouse_prefab.create();this.mouse_root.addChild(t);var a=9*Math.random();a=Math.floor(a),t.x=e.pointArray[a].x,t.y=e.pointArray[a].y;var s=1,n=5;this.time>60?(s=Math.random()<.11?2:1,n=5):this.time>30?(s=Math.random()<.41?2:1,n=3):this.time>1&&(s=Math.random()<.21?2:1,n=4),t.getComponent(i).showMouse(this,s,a,n);var l=(2+2*Math.random())*n*100;l=Math.floor(l),Laya.timer.once(l,this,this.createMouses)}mouseBeHited(t,i,n){var l=this.score_prefab.create();this.score_root.addChild(l),l.x=e.pointArray[n].x,l.y=e.pointArray[n].y-300,l.getComponent(s).showScore(t,i,n),this.hammer.x=e.pointArray[n].x+170,this.hammer.y=e.pointArray[n].y-100,this.hammer.getComponent(a).showHammer()}showWhichBack(e=1){switch(console.log(this.homeBack),e){case 1:this.homeBack.visible=!0,this.canvas.visible=!1,this.overCanvas.visible=!1;break;case 2:this.homeBack.visible=!1,this.canvas.visible=!0,this.overCanvas.visible=!1,this.BeginGame(),this.main_Ctrl.BeginGame();break;case 3:this.homeBack.visible=!1,this.canvas.visible=!1,this.overCanvas.visible=!0,this.over_Ctrl.ShowOver(this);break;default:this.homeBack.visible=!0,this.canvas.visible=!1,this.overCanvas.visible=!1}}BeginGame(){this.time=this.roundTime,this.score=0,this.count_down.text=this.time.toString(),this.all_score.text=this.score.toString(),this.createMouses(),this.countDownEvent()}scoreCount(e){this.score=1==e?this.score+100:this.score-100,this.all_score.text=this.score.toString()}countDownEvent(){this.time>=1?Laya.timer.once(1e3,this,function(){this.time--,this.count_down.text=this.time.toString(),this.countDownEvent()}):(Laya.timer.clearAll(this),this.showWhichBack(3))}onStart(){this.showWhichBack(1)}}class _ extends Laya.Script{constructor(){super()}onClick(){null!=this.target&&(this.target.visible=!1)}}class m{constructor(){}static init(){var e=Laya.ClassUtils.regClass;e("script/game_mgr.ts",c),e("script/home_mgr.ts",h),e("script/hammer.ts",a),e("script/score.ts",s),e("script/main_mgr.ts",r),e("script/over_mgr.ts",o),e("script/ClickHideSelf.ts",_),e("script/mouse.ts",i)}}m.width=1080,m.height=1920,m.scaleMode="fixedauto",m.screenMode="vertical",m.alignV="top",m.alignH="left",m.startScene="main_scence.scene",m.sceneRoot="",m.debug=!1,m.stat=!1,m.physicsDebug=!1,m.exportSceneToJson=!0,m.init();new class{constructor(){window.Laya3D?Laya3D.init(m.width,m.height):Laya.init(m.width,m.height,Laya.WebGL),Laya.Physics&&Laya.Physics.enable(),Laya.DebugPanel&&Laya.DebugPanel.enable(),Laya.stage.scaleMode=m.scaleMode,Laya.stage.screenMode=m.screenMode,Laya.stage.alignV=m.alignV,Laya.stage.alignH=m.alignH,Laya.URL.exportSceneToJson=m.exportSceneToJson,(m.debug||"true"==Laya.Utils.getQueryString("debug"))&&Laya.enableDebugPanel(),m.physicsDebug&&Laya.PhysicsDebugDraw&&Laya.PhysicsDebugDraw.enable(),m.stat&&Laya.Stat.show(),Laya.alertGlobalError=!0,new n,new l,Laya.ResourceVersion.enable("version.json",Laya.Handler.create(this,this.onVersionLoaded),Laya.ResourceVersion.FILENAME_VERSION)}onVersionLoaded(){Laya.AtlasInfoManager.enable("fileconfig.json",Laya.Handler.create(this,this.onConfigLoaded))}onConfigLoaded(){m.startScene&&Laya.Scene.open(m.startScene),l._instance.isChallenge&&setTimeout(()=>{n._instance.UpdateChallengeData(l._instance.challengeId),l._instance.isChallenge=!1},500)}}}();